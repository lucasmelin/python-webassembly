
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>A Talk Near the Future of Python</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-orange">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#david-beazley-a-talk-near-the-future-of-python-aka-dave-live-codes-a-webassembly-interpreter" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="A Talk Near the Future of Python" class="md-header__button md-logo" aria-label="A Talk Near the Future of Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            A Talk Near the Future of Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              David Beazley - A Talk Near the Future of Python (a.k.a., Dave live-codes a WebAssembly Interpreter)
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-orange"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_2">
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="A Talk Near the Future of Python" class="md-nav__button md-logo" aria-label="A Talk Near the Future of Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    A Talk Near the Future of Python
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="." class="md-nav__link md-nav__link--active">
        David Beazley - A Talk Near the Future of Python (a.k.a., Dave live-codes a WebAssembly Interpreter)
      </a>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="david-beazley-a-talk-near-the-future-of-python-aka-dave-live-codes-a-webassembly-interpreter">David Beazley - A Talk Near the Future of Python (a.k.a., Dave live-codes a WebAssembly Interpreter)</h1>
<iframe width="560" height="315" src="https://www.youtube.com/embed/r-A78RgMhZU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>When you start working with machines, you start coming across a lot of different structures. One of the things you might come across is a <a href="https://en.wikipedia.org/wiki/Stack_(abstract_data_type)"><em>stack</em></a>.</p>
<pre class="mermaid"><code>flowchart LR
    subgraph STACK
        1 o--o 2
        2 o--o 3
        3 o--o 4
    end

    Push o--&gt; 1
    1 --&gt; Pop</code></pre>
<p>A stack is actually really easy to implement in python, you start with a list and then a stack has two operations on it - a <em>"push items"</em> where we just append something onto the stack, and a <em>"pop items"</em> where we just return something back from the stack.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Stack</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>
<p>Now, it turns out that stacks can be used for all sorts of amazing stuff, like making little machines. You can actually use this stack structure to make your own little machine code or executor.</p>
<p>An example of what something like that might look like, is you can come up with a little stack-based machine language, for example:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Stack</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>


<span class="hll"><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
</span><span class="hll">    <span class="c1"># Compute 2 + 3 * 0.1</span>
</span><span class="hll">    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
</span><span class="hll">    <span class="p">]</span>
</span></code></pre></div>
<p>This example computes <code>2 + 3 * 0.1</code>. Here's how we might go about doing something like that - we'll start by taking our stack and giving it an <code>execute</code> method.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span> <span class="c1"># We&#39;ve renamed our Stack class</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="hll">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
</span><span class="hll">            <span class="o">...</span>
</span>

<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># Compute 2 + 3 * 0.1</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
    <span class="p">]</span>
</code></pre></div>
<p>Then we'll write a little loop where we just execute op-codes in this instruction sequence. We can say <em>"give me an operation and maybe some arguments to the instruction"</em>, and then we can write a little machine.</p>
<p>For instance, we can say if the op is <code>const</code>, then we push something onto the stack.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
<span class="hll">            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></code></pre></div>
<p>If the op is <code>add</code>, then we can implement it as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="hll">            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c1"># (1)</span>
</span><span class="hll">                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c1"># (2)</span>
</span><span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span> <span class="c1"># (3)</span>
</span></code></pre></div>
<ol>
<li>Pull the <code>right</code> thing off of the stack.</li>
<li>Pull the <code>left</code> thing off of the stack.</li>
<li>Put the <code>result</code> back <em>onto</em> the stack.</li>
</ol>
<p>We can implement <code>multiply</code> in much the same way.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
<span class="hll">            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class="hll">                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
</span></code></pre></div>
<p>Let's also add a <code>print</code> statement to our execute method, and a safeguard in case we mess up later so we can see what's going on when we run this:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
<span class="hll">            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
</span>            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
<span class="hll">            <span class="k">else</span><span class="p">:</span>
</span><span class="hll">                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span>
<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># Compute 2 + 3 * 0.1</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example</span><span class="p">()</span>
</code></pre></div>
<p>All of a sudden, we're on the way to making a little machine.</p>
<p>The way that this works is that we setup our little machine, then we execute code, and then if it works, the result will just be there on the top of the stack.</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">python</span> <span class="n">machine</span><span class="o">.</span><span class="n">py</span>
<span class="go">const [2] []</span>
<span class="go">const [3] [2]</span>
<span class="go">const [0.1] [2, 3]</span>
<span class="go">mul [] [2, 3, 0.1]</span>
<span class="go">add [] [2, 0.30000000000000004]</span>
<span class="go">Result: 2.3</span>
</code></pre></div>
<p>What we can see is that it's churning through operations, and what comes out is the result <code>2.3</code>.</p>
<p>So now we've got the start of a little machine. If we start playing around with this a little bit more, we start thinking <em>"maybe I could make this more like a CPU, I could give it more features"</em>. So maybe one of the features we want to give it is some memory by adding a bytearray of simulated memory:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
<span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span> <span class="c1"># (1)</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># Compute 2 + 3 * 0.1</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example</span><span class="p">()</span>
</code></pre></div>
<ol>
<li>The most memory we could <em>possibly</em> need is 64k. <img alt="😉" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f609.svg" title=":wink:" /></li>
</ol>
<p>Then maybe we start adding some functions to <code>store</code> and <code>load</code> from memory:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

<span class="hll">    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
</span><span class="hll">        <span class="o">...</span>
</span>
<span class="hll">    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span><span class="hll">        <span class="o">...</span>
</span>
    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># Compute 2 + 3 * 0.1</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example</span><span class="p">()</span>
</code></pre></div>
<p>The problem with loading and storing is that we'll have to make some decisions about how the memory actually <em>works</em>. We'll have to pull something out of the memory and make some decisions as to what's there.</p>
<p>So, for lack of a better alternative, let's just assume that <em>everything</em> is a floating point number. We'll basically do some memory unpacking of a value.</p>
<div class="highlight"><pre><span></span><code><span class="hll"><span class="kn">import</span> <span class="nn">struct</span> <span class="c1"># (1)</span>
</span>
<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
<span class="hll">        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span>
    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span>
<span class="c1"># Code below ommitted 👇</span>
</code></pre></div>
<ol>
<li>
<div class="admonition info">
<p class="admonition-title">Info</p>
If you haven't used the <code>struct</code> module before in python, it's a way of packing values. <a href="https://docs.python.org/3/library/struct.html">https://docs.python.org/3/library/struct.html</a></div>
</li>
</ol>
<p>Now we can add some more instructions for <code>load</code> and <code>store</code>.</p>
<p>Loading will be popping a value off the stack and then pushing the value of loading it.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
<span class="hll">            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;load&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span>            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;store&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Code below ommitted 👇</span>
</code></pre></div>
<p>If we want to do a store, we would get a value off the stack and then get an address off of the stack, and then put that into memory.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;load&#39;</span><span class="p">:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
<span class="hll">            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;store&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class="hll">                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Now that we've added these types of instructions, suddenly our programs start to be able to be more powerful, having the concept of <strong>variables</strong>. In order to make that work, we need to give our variables a memory address - effectively these are pointers.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># x = 2</span>
    <span class="c1"># v = 3</span>
    <span class="c1"># x = x + v * 0.1</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
</code></pre></div>
<p>So we need to pick some number where <code>x</code> and <code>v</code> are going to "live".</p>
<p>If we want to load from variables, the basic steps are:</p>
<ol>
<li>Put the address of a variable on the stack.</li>
<li>Load it.</li>
<li>Put the address of the <em>other</em> variable on the stack.</li>
<li>Load <em>that</em>.</li>
<li>Store the resulting value.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># x = 2</span>
    <span class="c1"># v = 3</span>
    <span class="c1"># x = x + v * 0.1</span>
<span class="hll">    <span class="n">x_addr</span> <span class="o">=</span> <span class="mi">22</span>
</span><span class="hll">    <span class="n">v_addr</span> <span class="o">=</span> <span class="mi">42</span>
</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
<span class="hll">        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,),</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
</span><span class="hll">        <span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,),</span>
</span>        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
<span class="hll">        <span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,)</span>
</span>    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We've got this structured a little weirdly, we have to put the address <em>first</em> and then the value to store <em>afterwards</em>.</p>
</div>
<p>The way the machine works, we need to make sure we're setting up our variables, and then at the end, instead of popping something out, we would just load it out of <code>x</code>:</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;load&#39;</span><span class="p">:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;store&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># x = 2</span>
    <span class="c1"># v = 3</span>
    <span class="c1"># x = x + v * 0.1</span>
    <span class="n">x_addr</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="n">v_addr</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,)</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">()</span>
<span class="hll">    <span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">x_addr</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
</span><span class="hll">    <span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">v_addr</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
</span>    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="hll">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x_addr</span><span class="p">))</span>
</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example</span><span class="p">()</span>
</code></pre></div>
When we run this, we get the same result as before:</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">python</span> <span class="n">machine</span><span class="o">.</span><span class="n">py</span>
<span class="go">const [22] []</span>
<span class="go">const [22] [22]</span>
<span class="go">load [] [22, 22]</span>
<span class="go">const [42] [22, 2.0]</span>
<span class="go">load [] [22, 2.0, 42]</span>
<span class="go">const [0.1] [22, 2.0, 3.0]</span>
<span class="go">mul [] [22, 2.0, 3.0, 0.1]</span>
<span class="go">add [] [22, 2.0, 0.30000000000000004]</span>
<span class="go">store [] [22, 2.3]</span>
<span class="go">Result: 2.3</span>
</code></pre></div>
<p>Now, you might be looking at this code and saying <em>"Well that's great, we have math operations, we have load and store and stuff, but what we really need is some <strong>functions</strong>."</em></p>
<p>Could we add that, some function <code>update_position</code> that computes that result?</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
<span class="hll">    <span class="c1"># def update_position(x, v, dt):</span>
</span><span class="hll">    <span class="c1">#     return x + v * dt</span>
</span>    <span class="c1"># x = 2</span>
    <span class="c1"># v = 3</span>
    <span class="c1"># x = x + v * 0.1</span>
    <span class="n">x_addr</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="n">v_addr</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,)</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">x_addr</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">v_addr</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x_addr</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example</span><span class="p">()</span>
</code></pre></div>
<p>It turns out that that's not too difficult to implement as well. We introduce the concept of a function to our machine using a <code>Function</code> class.</p>
<p>There's a few concepts related to functions such as <em>"how many parameters does the function take, does it return a value, what code is associated with it?"</em> which we'll add to our class too:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="hll"><span class="k">class</span> <span class="nc">Function</span><span class="p">:</span>
</span><span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nparams</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="n">nparams</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
</span>

<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

<span class="c1"># Code below ommitted 👇</span>
</code></pre></div>
<p>Then what we need to do is add a little bit of stuff to our machine to make <strong>function calls</strong> work.</p>
<p>One way we can implement that is by adding a <code>call</code> method where we pass in a function and some arguments, and then we setup a function call.</p>
<p>Another thing we need with functions is the concept of <strong>local variables</strong>. Normally when we call a function, we get new local variables and parameters.</p>
<p>So we need make a map between the numbers and the arguments, then send our locals and our function code to the execute function. Finally, if the function returns something, we'll pop something off of the stack.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="k">class</span> <span class="nc">Function</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nparams</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="n">nparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>

<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="hll">    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span class="hll">        <span class="nb">locals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">))</span> <span class="c1"># (1)</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
</span><span class="hll">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span>
<span class="c1"># Code below ommitted 👇</span>
</code></pre></div>
<ol>
<li><code>{0: args[0], 1:args[1], 2: args[2]}</code></li>
</ol>
<p>We then modify our execute code to take in the locals and then build some more features around it such as operations for dealing with the local variables. For instance, we can create an operator for <code>local.get</code> that puts something onto the stack by looking it up in the locals dictionary.</p>
<div class="highlight"><pre><span></span><code><span class="hll">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
</span>        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;load&#39;</span><span class="p">:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;store&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
<span class="hll">            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;local.get&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<p>We can then add another operation <code>local.set</code> that does the opposite.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;load&#39;</span><span class="p">:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;store&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;local.get&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="hll">            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;local.set&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<p>This is similar to <code>load</code> and <code>store</code>, except that it's manipulating the locals piece a little bit.</p>
<p>The other thing we need for functions is we need some way to <em>call</em> a function. This is a little bit tricky, because inside of our call we need some way to reference the function.</p>
<p>In order to do that, we're going to extend our machine with a <strong>function table</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="k">class</span> <span class="nc">Function</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nparams</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="n">nparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>

<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
<span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="n">functions</span> <span class="c1"># function table</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="c1"># Code below ommitted 👇</span>
</code></pre></div>
<p>And then inside our <code>call</code> operator, we'll look up the function. We also need the arguments for our function, so we'll pop those off the stack. One tricky thing about popping the arguments off the stack is that they're going to be in reverse order.</p>
<p>Then we have all the information needed to call our function. If our function returns something, then we'll take the result and put it back on the stack.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;mul&#39;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;load&#39;</span><span class="p">:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;store&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;local.get&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;local.set&#39;</span><span class="p">:</span>
                <span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="hll">            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span class="hll">                <span class="c1"># The underscore just means we&#39;re disregarding the variable.</span>
</span><span class="hll">                <span class="n">fargs</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">([</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">nparams</span><span class="p">)</span> <span class="p">])</span>
</span><span class="hll">                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">fargs</span><span class="p">)</span>
</span><span class="hll">                <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
</span><span class="hll">                    <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>returns</code> we're treating as a boolean, as in <em>does this function return something or not?</em></p>
</div>
<p>What this means in our machine code is that you would have to define functions in the machine code:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="k">class</span> <span class="nc">Function</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nparams</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="n">nparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>

<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="n">functions</span>  <span class="c1"># function table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;d&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span> <span class="p">:</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span> <span class="p">:</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">locals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>  <span class="c1"># {0: args[0], 1:args[1], 2: args[2]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;const&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;mul&quot;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span> <span class="o">*</span> <span class="n">right</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;store&quot;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;local.get&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;local.set&quot;</span><span class="p">:</span>
                <span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="c1"># The underscore just means we&#39;re disregarding the variable.</span>
                <span class="n">fargs</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">nparams</span><span class="p">)])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">fargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
<span class="hll">    <span class="n">update_position</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
</span><span class="hll">        <span class="n">nparams</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span class="hll">        <span class="n">returns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span class="hll">        <span class="n">code</span><span class="o">=</span><span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="s2">&quot;local.get&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># getting x</span>
</span><span class="hll">            <span class="p">(</span><span class="s2">&quot;local.get&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>  <span class="c1"># getting v</span>
</span><span class="hll">            <span class="p">(</span><span class="s2">&quot;local.get&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># getting dt</span>
</span><span class="hll">            <span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,),</span>
</span><span class="hll">            <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,),</span>
</span><span class="hll">        <span class="p">],</span>
</span><span class="hll">    <span class="p">)</span>
</span><span class="hll">    <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">update_position</span><span class="p">]</span>
</span>
    <span class="n">x_addr</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="n">v_addr</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
<span class="hll">        <span class="p">(</span><span class="s2">&quot;call&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Function 0: update_position</span>
</span>        <span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,),</span>
    <span class="p">]</span>
<span class="hll">    <span class="n">m</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span>
</span>    <span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">x_addr</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">v_addr</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x_addr</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example</span><span class="p">()</span>
</code></pre></div>
<p>When we execute it we get the exact same answer as before:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python machine.py
const <span class="o">[</span><span class="m">22</span><span class="o">]</span> <span class="o">[]</span>
const <span class="o">[</span><span class="m">22</span><span class="o">]</span> <span class="o">[</span><span class="m">22</span><span class="o">]</span>
load <span class="o">[]</span> <span class="o">[</span><span class="m">22</span>, <span class="m">22</span><span class="o">]</span>
const <span class="o">[</span><span class="m">42</span><span class="o">]</span> <span class="o">[</span><span class="m">22</span>, <span class="m">2</span>.0<span class="o">]</span>
load <span class="o">[]</span> <span class="o">[</span><span class="m">22</span>, <span class="m">2</span>.0, <span class="m">42</span><span class="o">]</span>
const <span class="o">[</span><span class="m">0</span>.1<span class="o">]</span> <span class="o">[</span><span class="m">22</span>, <span class="m">2</span>.0, <span class="m">3</span>.0<span class="o">]</span>
mul <span class="o">[]</span> <span class="o">[</span><span class="m">22</span>, <span class="m">2</span>.0, <span class="m">3</span>.0, <span class="m">0</span>.1<span class="o">]</span>
add <span class="o">[]</span> <span class="o">[</span><span class="m">22</span>, <span class="m">2</span>.0, <span class="m">0</span>.30000000000000004<span class="o">]</span>
store <span class="o">[]</span> <span class="o">[</span><span class="m">22</span>, <span class="m">2</span>.3<span class="o">]</span>
Result: <span class="m">2</span>.3
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This is actually how python itself works, it's actually a little stack machine. What's happening under the hood is python takes python code turns it into python machine code! You can see the same types of instructions as what we've been implementing - load x, load v, load dt, etc.</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">update_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dt</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">update_position</span><span class="p">)</span>
<span class="go">2           0 LOAD_FAST                0 (x)</span>
<span class="go">            2 LOAD_FAST                1 (v)</span>
<span class="go">            4 LOAD_FAST                2 (dt)</span>
<span class="go">            6 BINARY_MULTIPLY</span>
<span class="go">            8 BINARY_ADD</span>
<span class="go">            10 RETURN_VALUE</span>
</code></pre></div>
</div>
<p>One thing our machine is missing is a critical feature - there's no way to do control flow like with an <code>if</code> statement.</p>
<p>We also don't have any way to do loops, like <code>while</code> loops for example. Right now, our machine is just going through instructions and that's it. In order to implement these features, we need to introduce some type of branching instruction.</p>
<p>In order to do a branch, we'll need some <code>goto</code>-like statement, some kind of jump. <code>goto</code> statements tend to offend people, and we don't even <em>have</em> a <code>goto</code> statement in python. So what's the next best thing? Raising an exception! If we want our program to stop or branch, one way to do that is just to stop.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># The underscore just means we&#39;re disregarding the variable.</span>
        <span class="n">fargs</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">nparams</span><span class="p">)])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">fargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="hll">    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span><span class="p">:</span>
</span><span class="hll">        <span class="k">raise</span> <span class="n">Break</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class="hll">    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;br_if&#39;</span><span class="p">:</span> <span class="c1"># If the top thing on the stack is True, Break</span>
</span><span class="hll">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">():</span>
</span><span class="hll">            <span class="k">raise</span> <span class="n">Break</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="hll"><span class="k">class</span> <span class="nc">Break</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Not only are we breaking, but there's a level that we can dial up.</p>
</div>
<p>The other thing we'll introduce at this point is the idea of a <strong>code block</strong>, which is basically a nested set of instructions.</p>
<p>What we're going to do with the code block is essentially just try to execute it. We'll catch the <code>Break</code> exception, and if the level is still high, we'll decrement the level by one and re-raise the exception.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;br&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Break</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;br_if&#39;</span><span class="p">:</span> <span class="c1"># If the top thing on the stack is True, Break</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">Break</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="hll">    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>
</span><span class="hll">        <span class="k">try</span><span class="p">:</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">locals</span><span class="p">)</span>
</span><span class="hll">        <span class="k">except</span> <span class="n">Break</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="hll">                <span class="n">b</span><span class="o">.</span><span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class="hll">                <span class="k">raise</span>
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>This <em>looks</em> really strange. But what we get out of this is using nothing but <code>block</code> and <code>Break</code>, we can implement an <code>if</code> statement.</p>
<p>Here's what an <code>if</code> statement looks like in our machine code:</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="n">test</span>
        <span class="p">(</span><span class="s1">&#39;br_if&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1"># Goto 0</span>
        <span class="n">alternative</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># Goto 1</span>
    <span class="p">]),</span> <span class="c1"># Label : 0</span>
    <span class="n">consequence</span><span class="p">,</span>
<span class="p">])</span> <span class="c1"># Label : 1</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Basically, the end of the inner block is labelled <code>0</code>, and the end of the outer block is label <code>1</code>. And then our <code>br_if</code> and <code>br</code> instructions end up basically like <code>goto</code> statements.</p>
<p>We do the test, and if the test is <code>True</code>, then we bail on the rest of the block and skip to label <code>0</code> and run the consequence. If the test is <code>False</code>, then we run the alternative.</p>
</div>
<p>We can apply the same pattern to loops. To implement a <code>while</code> loop, we'll introduce a <code>loop</code> instruction. We're going to go into an infinite loop where we just try to execute a bunch of code and right after execution we break and do the same thing as before to catch the exception and decrement the level.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">locals</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Break</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">raise</span>
<span class="hll">    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;loop&#39;</span><span class="p">:</span>
</span><span class="hll">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span class="hll">            <span class="k">try</span><span class="p">:</span>
</span><span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">locals</span><span class="p">)</span>
</span><span class="hll">                <span class="k">break</span>
</span><span class="hll">            <span class="k">except</span> <span class="n">Break</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
</span><span class="hll">                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="hll">                    <span class="n">b</span><span class="o">.</span><span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class="hll">                    <span class="k">raise</span>
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad op </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>This is how we would introduce a <code>while</code> loop in our machine code. It turns out that these blocks basically have "magic labels" that we can go to.</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="c1"># Label 0</span>
        <span class="ow">not</span> <span class="n">test</span>
        <span class="p">(</span><span class="s1">&#39;br_if&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># Goto 1: (break)</span>
        <span class="n">body</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1"># Goto 0: (continue)</span>
    <span class="p">])</span>
<span class="p">])</span> <span class="c1"># Label 1</span>
</code></pre></div>
<p>The other thing we'll introduce is the funtion <code>Return</code>, which basically tries to break out of everything, which we'll catch up in our <code>call</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="k">class</span> <span class="nc">Function</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nparams</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="n">nparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>

<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="n">functions</span>  <span class="c1"># function table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;d&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span> <span class="p">:</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span> <span class="p">:</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="hll">    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span class="hll">        <span class="nb">locals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>  <span class="c1"># {0: args[0], 1:args[1], 2: args[2]}</span>
</span><span class="hll">        <span class="k">try</span><span class="p">:</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
</span><span class="hll">        <span class="k">except</span> <span class="n">Return</span><span class="p">:</span>
</span><span class="hll">            <span class="k">pass</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
</span><span class="hll">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;const&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="o">...</span>

<span class="hll">            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
</span><span class="hll">                <span class="k">raise</span> <span class="n">Return</span><span class="p">()</span>
</span>
<span class="hll"><span class="k">class</span> <span class="nc">Return</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span class="hll">    <span class="k">pass</span>
</span></code></pre></div>
<p>It turns out that having this allows us to write much more complicated programs.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Our machine program</label><label for="__tabbed_1_2">The same program in python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;le&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;br_if&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mf">70.0</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ge&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;br_if&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,)</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">])</span>
    <span class="p">])</span>
<span class="p">],</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># This None is the locals</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">update_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span>
</code></pre></div>
</div>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>What this is doing is it's creating a <code>while</code> loop where it's updating the position, and then checking if the position got too far, and if so, it flips the direction.</p>
</div>
<p>In order for this example to work, we need to add a few more operations to the machine.</p>
<p>It turns out we can't do <code>if</code> statements without conditionals or relations - we need things like <code>less than</code>, <code>greater than</code>, etc.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;sub&#39;</span><span class="p">:</span>
        <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">-</span><span class="n">right</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;le&#39;</span><span class="p">:</span>
        <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">&lt;=</span><span class="n">right</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;ge&#39;</span><span class="p">:</span>
        <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">left</span><span class="o">&gt;=</span><span class="n">right</span><span class="p">)</span>
</code></pre></div>
<p>Now we've reached a point where we have most of the makings of our machine.</p>
<p>But, it's hard to see any output from this machine - we don't have any display or something similar. It might be useful to have a python function that basically displays a player or something, that draws to the screen.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">py_display_player</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;0:&gt;&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
</code></pre></div>
<p>We want some way to execute our <code>py_display_player</code> function, so what about adding the ability to <strong>import a function</strong>? This allows us to bring in an external function that's not written in our machine, and <em>extend</em> our function table.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">py_display_player</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;0:&gt;&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>

    <span class="n">display_player</span> <span class="o">=</span> <span class="n">ImportFunction</span><span class="p">(</span><span class="n">nparams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">returns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">call</span><span class="o">=</span><span class="n">py_display_player</span><span class="p">)</span>

    <span class="o">...</span>

    <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">update_position</span><span class="p">,</span> <span class="n">display_player</span><span class="p">]</span>
</code></pre></div>
<p>Then we can add an extra instruction to do the import.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># while x &gt; 0:</span>
<span class="c1">#     x = update_position(x, v, 0.1)</span>
<span class="c1">#     if x &gt;= 70:</span>
<span class="c1">#         v = -v</span>

<span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span> <span class="c1"># load x</span>
            <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span> <span class="c1"># load x</span>
            <span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># cal the function to display</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;le&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;br_if&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">x_addr</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mf">70.0</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ge&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;br_if&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="n">v_addr</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,)</span>
            <span class="p">]),</span>
            <span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">])</span>
    <span class="p">])</span>
<span class="p">],</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># This None is the locals</span>
</code></pre></div>
<p>Adding this is not too difficult to do, we just base it off of our <code>Function</code> class, and then make the machine look for it.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="k">class</span> <span class="nc">Function</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nparams</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="n">nparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>

<span class="hll"><span class="k">class</span> <span class="nc">ImportFunction</span><span class="p">:</span>
</span><span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nparams</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="n">nparams</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span>
</span>
<span class="k">class</span> <span class="nc">Machine</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">memsize</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="n">functions</span>  <span class="c1"># function table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">memsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;d&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span> <span class="p">:</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span> <span class="p">:</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="hll">    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span class="hll">        <span class="nb">locals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>  <span class="c1"># {0: args[0], 1:args[1], 2: args[2]}</span>
</span><span class="hll">        <span class="c1"># if the function is a normal Function, do what we had before</span>
</span><span class="hll">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
</span><span class="hll">            <span class="k">try</span><span class="p">:</span>
</span><span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
</span><span class="hll">            <span class="k">except</span> <span class="n">Return</span><span class="p">:</span>
</span><span class="hll">                <span class="k">pass</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
</span><span class="hll">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class="hll">        <span class="c1"># if it&#39;s not a normal function and is instead in ImportFunction</span>
</span><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span><span class="hll">            <span class="c1"># return the value of calling the external thing</span>
</span><span class="hll">            <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></code></pre></div>
<p>But what we really want is not some text displaying on screen, we want something more visual, more interactive, something like <a href="https://aochagavia.github.io/rocket_wasm/">rocket game</a> where you can move and shoot, etc.</p>
<p><a href="https://github.com/aochagavia/rocket_wasm">Rocket game</a> is using <a href="https://webassembly.org/">WebAssembly</a> running in the browser, and it's written in <a href="https://www.rust-lang.org/">Rust</a>. What is Python's story for something like this?</p>
<p>What we're going to try to do, is run the Rust program inside of the interpreter that we just wrote. Because what we just wrote - is a WebAssembly interpreter.</p>
<p><code>program.wasm</code> is compiled from Rust as a binary file. The game is an HTML document with some Javascript and it's a mix of Javascript and WebAssembly.</p>
<p>The machine we wrote can execute WebAssembly, but in order to do that, we need to make some changes.</p>
<p>One of those changes is that WebAssembly is a tiny CPU which only understands 4 data types - ints and floats, 32 and 64-bits.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="p">(</span><span class="n">int32</span><span class="p">,</span> <span class="n">int64</span><span class="p">,</span> <span class="n">float32</span><span class="p">,</span> <span class="n">float64</span><span class="p">)</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We've imported these types from <code>numpy</code>, mainly so that we can claim this is a machine learning project. <img alt="😉" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f609.svg" title=":wink:" /></p>
</div>
<p>We'll add an assertion on the stack push operation to make sure that we're only using those datatypes.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="n">int32</span><span class="p">,</span> <span class="n">int64</span><span class="p">,</span> <span class="n">float32</span><span class="p">,</span> <span class="n">float64</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>
<p>WebAssembly has a richer set of instructions which we'll need to add as well. It has instructions for creating constants:</p>
<div class="highlight"><pre><span></span><code><span class="n">_const</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i32.const&#39;</span><span class="p">:</span> <span class="n">int32</span><span class="p">,</span>
    <span class="s1">&#39;i64.const&#39;</span><span class="p">:</span> <span class="n">int64</span><span class="p">,</span>
    <span class="s1">&#39;f32.const&#39;</span><span class="p">:</span> <span class="n">float32</span>
    <span class="s1">&#39;f64.const&#39;</span><span class="p">:</span> <span class="n">float64</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>It has instructions for binary operations, things like <code>add</code>, <code>subtract</code>, <code>multiply</code>, <code>divide</code>, etc. We define these as basically a big table of <code>lambda</code> functions - there's nothing particulary special about what we're doing here, we're just trying to do this compactly.</p>
<div class="highlight"><pre><span></span><code><span class="n">_binary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># 32-bit integer</span>
    <span class="s1">&#39;i32.add&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.sub&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.mul&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.div_s&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">//</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.div_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">uint32</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i32.and&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.or&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">|</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.xor&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.rem_s&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.rem_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="n">uint32</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i32.eq&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.ne&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.lt_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.le_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.gt_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.ge_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i32.lt_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">uint32</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i32.gt_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">uint32</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i32.le_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">uint32</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i32.ge_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">uint32</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i32.rotr&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="n">y</span><span class="p">))),</span>
    <span class="s1">&#39;i32.rotl&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="n">y</span><span class="p">))),</span>
    <span class="s1">&#39;i32.shr_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i32.shl&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">y</span><span class="p">),</span>

    <span class="c1"># 64-bit integer</span>
    <span class="s1">&#39;i64.add&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.sub&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.mul&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.div_s&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">//</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.div_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">uint64</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i64.and&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.or&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">|</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.xor&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.rem_s&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.rem_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="n">uint64</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i64.eq&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.ne&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.lt_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.le_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.gt_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.ge_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;i64.lt_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">uint64</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i64.gt_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">uint64</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i64.le_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">uint64</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i64.ge_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">uint64</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i64.rotr&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">64</span><span class="o">-</span><span class="n">y</span><span class="p">))),</span>
    <span class="s1">&#39;i64.rotl&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span><span class="o">-</span><span class="n">y</span><span class="p">))),</span>
    <span class="s1">&#39;i64.shr_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
    <span class="s1">&#39;i64.shl&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">y</span><span class="p">),</span>

    <span class="c1"># -- 64 bit float</span>
    <span class="s1">&#39;f64.add&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.sub&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.mul&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.div&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.eq&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.ne&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.lt&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.gt&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.le&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span><span class="p">),</span>
    <span class="s1">&#39;f64.ge&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>
<p>There's also some unary operations, things like square root calculations, comparisons and so forth.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">math</span>
<span class="n">_unary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i32.eqz&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;i32.clz&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">2</span><span class="p">:])),</span>
    <span class="s1">&#39;i32.ctz&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
    <span class="s1">&#39;i32.wrap_i64&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
    <span class="s1">&#39;i64.extend_i32_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
    <span class="s1">&#39;f64.reinterpret_i64&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">frombuffer</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span> <span class="n">float64</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;f64.sqrt&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
    <span class="s1">&#39;f64.convert_i32_u&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
<span class="p">}</span>
</code></pre></div>
<p>There's also some operations for loading from memory. WebAssembly has these 4 data types, and it has different options for loading memory in different configurations.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">int8</span><span class="p">,</span> <span class="n">uint8</span><span class="p">,</span> <span class="n">int16</span><span class="p">,</span> <span class="n">uint16</span><span class="p">,</span> <span class="n">uint32</span><span class="p">,</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">frombuffer</span><span class="p">,</span>
     <span class="p">)</span>

<span class="n">_load</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i32.load&#39;</span>     <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">int32</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;i64.load&#39;</span>     <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;f64.load&#39;</span>     <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">float64</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;i32.load8_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">int8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i32.load8_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">uint8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i32.load16_s&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">int16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i32.load16_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int32</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">uint16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i64.load8_s&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">int8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i64.load8_u&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">uint8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i64.load16_s&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">int16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i64.load16_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">uint16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i64.load32_s&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">int32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="s1">&#39;i64.load32_u&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">uint32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
<span class="p">}</span>

<span class="n">_store</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i32.store&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span>
    <span class="s1">&#39;i64.store&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span>
    <span class="s1">&#39;f64.store&#39;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span>
    <span class="s1">&#39;i32.store8&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[:</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;i32.store16&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[:</span><span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;i64.store8&#39;</span>  <span class="p">:</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[:</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;i64.store16&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[:</span><span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;i64.store32&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[:</span><span class="mi">4</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div>
<p>Mostly what we're doing here is just inserting tables of short little functions. The code we've written can be modified to work with that - instead of using our minimal set of instructions, we're going to check for some table lookups.</p>
<p>WebAssembly also has a few more memory operators we have to implement.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">_const</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">_const</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># (1)</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">_binary</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">_binary</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">_unary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">_unary</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">_load</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (2)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">_load</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">]))</span> <span class="c1"># (3)</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">_store</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">_store</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="n">val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">:</span><span class="n">addr</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)]</span> <span class="o">=</span> <span class="n">raw</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;memory.size&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span><span class="o">//</span><span class="mi">65536</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;memory.grow&#39;</span><span class="p">:</span>
            <span class="n">npages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">npages</span><span class="o">*</span><span class="mi">65536</span><span class="p">))</span> <span class="c1"># (4)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span><span class="o">//</span><span class="mi">65536</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;local.get&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;local.set&#39;</span><span class="p">:</span>
            <span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;local.tee&#39;</span><span class="p">:</span> <span class="c1"># (5)</span>
            <span class="nb">locals</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span> <span class="c1"># (6)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;select&#39;</span><span class="p">:</span> <span class="c1"># (7)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">v1</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="n">v2</span><span class="p">)</span>

        <span class="o">...</span>

        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">locals</span><span class="p">)</span> <span class="c1"># (8)</span>
            <span class="k">except</span> <span class="n">Break</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;br_table&#39;</span><span class="p">:</span> <span class="c1"># (9)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">Break</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Break</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
<ol>
<li>Lookup in the const table</li>
<li>WebAssembly introduces an offset</li>
<li>This is a hack because nothing is larger than 64 bits.</li>
<li>WebAssembly treats memory essentially as a big byte array that you grow and shrink.</li>
<li>New operation where we pull an item off the stack without consuming it.</li>
<li>Just pop something off of the stack and forget about it.</li>
<li>Basically a ternary operation or a conditional</li>
<li>WebAssembly introduces a block type which we're going to ignore, but it changes the offset we're using on this line.</li>
<li>You pass a table of indexes along with a default, used to implement switch statements</li>
</ol>
<p>Now the claim is that this code can run the rocket game, it can run the WebAssembly program written in Rust.</p>
<p>In order to do that, we still have this problem that WebAssembly is binary. How do we turn that into the Rocket game? It turns out that this format is very easy to decode. WebAssembly kinda rethought the whole concept of a DLL. wadze allows you to parse a WebAssembly module.</p>
<p>There's a lot of useful stuff inside the WebAssembly module. For starters, there's a whole bunch of information about the type signatures of all functions in the modules. One of the big problem with C libraries is that they do not encode type signatures. If you make a DLL, the type information is not in the DLL, it's in the C header file. So you have to parse through the C header files. In contrast, with WebAssembly, all the type signatures are included in the module. Another interesting thing about WebAssembly is that it will tell you what needs to be imported. These are basically functions that are defined outside of WebAssembly and have to be provided by Python or Javascript. It also has information about what is exported, what functions are defined that are exported from the module.</p>
<p>This is basically going to be the basis for our WebAssembly piece. For instance, the imported functions are things that <em>have</em> to be implemented in python or Javascript, it's the functions that the module doesn't know about.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">wadze</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">wadze</span><span class="o">.</span><span class="n">parse_module</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;program.wasm&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># These functions are imported by Wasm.</span>
<span class="c1"># Must be implemented in the host environment (Python).</span>
<span class="c1"># These are listed in the required order.</span>
<span class="k">def</span> <span class="nf">imp_Math_atan</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">float64</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">imp_clear_screen</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clear_screen&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_cos</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">float64</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">imp_draw_bullet</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;draw_bullet&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_enemy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;draw_enemy&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_particle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;draw_particle&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_player</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;draw_player&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_score</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;draw_score&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_sin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">float64</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">machine</span>

<span class="c1"># (1)</span>
<span class="n">imported_functions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imp_Math_atan</span><span class="p">),</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imp_clear_screen</span><span class="p">),</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imp_cos</span><span class="p">),</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imp_draw_bullet</span><span class="p">),</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imp_draw_enemy</span><span class="p">),</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imp_draw_particle</span><span class="p">),</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imp_draw_player</span><span class="p">),</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imp_draw_score</span><span class="p">),</span>
    <span class="n">machine</span><span class="o">.</span><span class="n">ImportFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imp_sin</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># (2)</span>
<span class="n">defined_functions</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>

<span class="k">for</span> <span class="n">typeidx</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">],</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]):</span> <span class="c1"># (3)</span>
    <span class="n">functype</span> <span class="o">=</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">][</span><span class="n">typeidx</span><span class="p">]</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">nparams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">functype</span><span class="o">.</span><span class="n">params</span><span class="p">),</span>
                            <span class="n">returns</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">functype</span><span class="o">.</span><span class="n">returns</span><span class="p">),</span>
                            <span class="n">code</span> <span class="o">=</span> <span class="n">wadze</span><span class="o">.</span><span class="n">parse_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">instructions</span><span class="p">)</span>
    <span class="n">defined_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<span class="n">functions</span> <span class="o">=</span> <span class="n">imported_functions</span> <span class="o">+</span> <span class="n">defined_functions</span> <span class="c1"># (4)</span>

<span class="c1"># (5)</span>
<span class="n">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="n">exp</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">functions</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">ref</span><span class="p">]</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;export&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">wadze</span><span class="o">.</span><span class="n">ExportFunction</span><span class="p">)</span> <span class="p">}</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="mi">65536</span><span class="p">)</span> <span class="c1"># (6)</span>

<span class="c1"># (7)</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>

<span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">float64</span><span class="p">,</span> <span class="n">int32</span>

<span class="n">width</span> <span class="o">=</span> <span class="n">float64</span><span class="p">(</span><span class="mf">800.0</span><span class="p">)</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">float64</span><span class="p">(</span><span class="mf">600.0</span><span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;resize&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="c1"># (8)</span>
</code></pre></div>
<ol>
<li>Declare as imported functions for our "machine"</li>
<li>Declare "defined" functions, functions that are in WebAssembly</li>
<li>Take the two pieces from the module</li>
<li>Complete function table of python functions and Rust code functions</li>
<li>Declare "exported" functions</li>
<li>Hack on memory, the file does indicate how much memory the program needs but we're not going to bother</li>
<li>Initialize memory</li>
<li>Call the resize function in Rust <img alt="🙏" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f64f.svg" title=":pray:" /></li>
</ol>
<p>Our program is doing something at this point, it's not crashing.</p>
<p>From here, let's just add a <strong>game loop</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Game loop</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">now</span>
    <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">],</span> <span class="n">float64</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span> <span class="c1"># Call the update on the time delta</span>
    <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">])</span> <span class="c1"># update and draw are both WebAssembly functions written in Rust.</span>
</code></pre></div>
<p>Our program is looping, but we want to be able to see what this is doing a little bit better.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="c1"># Turn off the print statement</span>
            <span class="c1"># print(op, args, self.items)</span>
</code></pre></div>
<p>We can now see what functions are being called. But we'd like to do something a bit more interesting with those functions.</p>
<p>Instead of just printing, maybe a more interesting thing to do would be to pump this over to pygame. With pygame, we'll need to add a bit of event handling to our game loop too.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pygame</span>

<span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="n">size</span> <span class="o">=</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
<span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="c1"># font = pygame.font.SysFont(&quot;helvetica&quot;, 36)</span>

<span class="k">def</span> <span class="nf">imp_clear_screen</span><span class="p">():</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">imp_draw_bullet</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_enemy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_particle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">imp_draw_player</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_score</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;draw_score&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="c1">#    text = font.render(f&#39;Score: {int(s)}&#39;, True, (200,200, 0))</span>
<span class="c1">#    screen.blit(text, (5, 5))</span>

<span class="c1"># Game loop</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">now</span>
    <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">],</span> <span class="n">float64</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span> <span class="c1"># Call the update on the time delta</span>
    <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">])</span> <span class="c1"># update and draw are both WebAssembly functions written in Rust.</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span> <span class="c1"># The way to get pygame to render</span>
</code></pre></div>
<p>Now we want to play the game, but we didn't put any keybindings in!</p>
<p>That's not hard to add - we just check for different keys, and then based on those keys, we call more Rust functions to do things like toggle shooting, turn left, etc.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pygame</span>

<span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="n">size</span> <span class="o">=</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
<span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="c1"># font = pygame.font.SysFont(&quot;helvetica&quot;, 36)</span>

<span class="k">def</span> <span class="nf">imp_clear_screen</span><span class="p">():</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">imp_draw_bullet</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_enemy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_particle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">imp_draw_player</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">imp_draw_score</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;draw_score&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="c1">#    text = font.render(f&#39;Score: {int(s)}&#39;, True, (200,200, 0))</span>
<span class="c1">#    screen.blit(text, (5, 5))</span>

<span class="c1"># Game loop</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">QUIT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">KEYUP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;toggle_shoot&#39;</span><span class="p">],</span> <span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="mi">275</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;toggle_turn_right&#39;</span><span class="p">],</span> <span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="mi">276</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;toggle_turn_left&#39;</span><span class="p">],</span> <span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="mi">273</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;toggle_boost&#39;</span><span class="p">],</span> <span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">KEYDOWN</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;toggle_shoot&#39;</span><span class="p">],</span> <span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="mi">275</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;toggle_turn_right&#39;</span><span class="p">],</span> <span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="mi">276</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;toggle_turn_left&#39;</span><span class="p">],</span> <span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="mi">273</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;toggle_boost&#39;</span><span class="p">],</span> <span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">now</span>
    <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">],</span> <span class="n">float64</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span> <span class="c1"># Call the update on the time delta</span>
    <span class="n">m</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">exports</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">])</span> <span class="c1"># update and draw are both WebAssembly functions written in Rust.</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span> <span class="c1"># The way to get pygame to render</span>
</code></pre></div>
<p>Now we can run the program and play the game!</p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Just to recap - this is a <strong>Rust program</strong>, running in an <strong>interpreter in Python</strong>, and it's all running as an <strong>interpreted stack machine</strong>.</p>
</div>
<p>This is sorta awesome, and it brings us to a future of python. Some people talk about <em>"What is the future of Python, does it have a WebAssembly story, what's going on with the types in Python"</em>, etc. The thing about this WebAssembly stuff is that it's not well-known, but it's super cool.</p>
<p>If you're looking for some weird, crazy project to work on that's really super interesting, look at WebAssembly. It has almost nothing to do with web programming in any conventional sense. WebAssembly is that emulated machine, it's like a target for Rust and C++ and C, you can compile stuff to it, you can make extension modules. And yes, you <em>can</em> run it in the browser if you want, but you don't <em>have</em> to. There's a lot of interesting possibilities with this.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Here are some interesting links to projects involving WebAssembly and Python:</p>
<ol>
<li><a href="https://webassembly.github.io/spec/">The WebAssembly spec</a></li>
<li><a href="www.youtube.com/watch?v=u2kKxmb9BWs">Almar Klein's EuroPython 2018 talk</a>.
Highly recommended. He does other neat stuff with Rocket.</li>
<li><a href="github.com/iodide-project/pyodide">pyodide</a> - Scientific Stack on Web Assembly</li>
<li><a href="https://ppci.readthedocs.io">Pure Python Compiler Infrastructure (PPCI)</a></li>
<li><a href="https://wasmer.io">Wasmer</a></li>
</ol>
</div>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.top", "content.code.annotate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>